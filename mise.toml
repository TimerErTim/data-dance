[tools]
node = "25.2.0"
rust = "nightly"

[tasks."setup:btrfs-local-unmount"]
description = "Unmount the btrfs local image file for easy local testing"
run = [
    "sudo umount local/btrfs-mnt/ || true",
]

[tasks."setup:btrfs-local-img"]
description = "Setup a btrfs local image file for easy local testing"
depends = ["setup:btrfs-local-unmount"]
outputs = ["local/btrfs.img"]
sources = ["local/btrfs.img"]
run = [
    "dd if=/dev/zero of=local/btrfs.img bs=1G count=8",
    "mkfs.btrfs local/btrfs.img",
]

[tasks."setup:btrfs-local-mount"]
description = "Mount the btrfs local image file for easy local testing"
run = [
    "mkdir -p local/btrfs-mnt/",
    "sudo mount -o loop,user local/btrfs.img local/btrfs-mnt/",
    "sudo chown --reference=local local/btrfs-mnt/",
]

[tasks."install:frontend"]
description = "Install the frontend dependencies"
dir = "frontend/"
sources = ["package.json", "package-lock.json"]
outputs = ["node_modules/**/*"]
run = [
    "npm install",
]

[tasks."build:frontend"]
description = "Build the frontend"
dir = "frontend/"
sources = ["package.json", "package-lock.json", "next.config.ts", "tsconfig.json", "tailwind.config.js", "postcss.config.js", "src/**/*", "public/**/*"]
outputs = ["out/**/*"]
depends = ["build:openapi-fetch-spec"]
run = [
    "npm run build",
]

[tasks."dev:frontend"]
description = "Run the frontend development server"
dir = "frontend/"
run = [
    "npm run dev",
]

[tasks."dev:server"]
description = "Run the server in development mode"
env.DATA_DANCE_CONFIG = "resources/testing/config.toml"
run = [
    "cargo run",
]

[tasks."build:openapi-fetch-spec"]
description = "Fetch the OpenAPI spec from the server and inject into client"
sources = ["Cargo.toml", "Cargo.lock", "src/**/*"]
outputs = ["frontend/src/lib/api/spec.ts"]
run = """
#!/usr/bin/env bash
set -e

# Start the dev server in the background
mise run --quiet --raw dev:server &
SERVER_PID=$!

# Function to cleanup on exit
cleanup() {
    if kill -0 $SERVER_PID 2>/dev/null; then
        echo "Terminating dev server (PID: $SERVER_PID)..."
        kill -9 $SERVER_PID
    fi
}

# Set trap to cleanup on script exit
trap cleanup EXIT

# Wait for server to be healthy (probe /api/spec endpoint)
echo "Waiting for dev server to be ready..."
TIMEOUT=30
ELAPSED=0

sleep 5 # Initial wait for server to start
while [ $ELAPSED -lt $TIMEOUT ]; do
    if ! kill -0 $SERVER_PID 2>/dev/null; then
        echo "Dev server process died unexpectedly"
        exit 1
    fi

    if curl -s -f http://localhost:3000/api/spec > /dev/null 2>&1; then
        echo "Dev server is ready!"
        break
    fi
    
    sleep 1
    ELAPSED=$((ELAPSED + 1))
done

if [ $ELAPSED -ge $TIMEOUT ]; then
    echo "Timeout waiting for dev server to be ready"
    exit 1
fi

# Fetch the OpenAPI spec using openapi-fetch
echo "Fetching OpenAPI spec..."
npx -y openapi-typescript http://localhost:3000/api/spec -o frontend/src/lib/api/spec.ts

echo "OpenAPI spec generated successfully!"
echo "killing dev server..."
kill -9 $SERVER_PID
"""

[tasks."build:server"]
description = "Build the server for release with embedded frontend"
sources = ["Cargo.toml", "Cargo.lock", "src/**/*"]
outputs = ["target/release/data-dance"]
depends = ["build:frontend"]
run = [
    "rm -rf target/site/",
    "cp -r frontend/out target/site",
    "cargo build --release",
]

[tasks."run:server"]
description = "Runs the built release server"
depends = ["build:server"]
env.DATA_DANCE_CONFIG = "resources/testing/config.toml"
run = [
    "target/release/data-dance",
]
